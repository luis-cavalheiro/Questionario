<!DOCTYPE html>
<html>
    <head>
        <!-- Jquery -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

        <!-- bootstrap -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

        <!-- font awesome -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        
        <!-- css -->
        <link rel="stylesheet" href="style.css">

        <!-- Imports -->
        <script type="text/javascript" src="questionario.js"></script>
        <script type="text/javascript" src="questTeste.js"></script>
        <script type="text/javascript" src="db.js"></script>
    </head>
    <body>
        <!-- Botoes superior -->
        <div class="container mt-5">
            <!-- botoes -->
            <div class="row">
                <!-- Criar -->
                <div class="col-md-12 col-lg-4 mb-5">
                    <div class="button" onclick="editarQuestionario(null)">
                        <div><i class="fa-solid fa-plus"></i> Criar</div>
                    </div>
                </div>
                <!-- Carregar-->
                <div class="col-md-12 col-lg-4 mb-5">
                    <label for="fileInput" class="button">
                        <div><i class="fa-solid fa-upload"></i> Carregar</div>
                    </label>
                    <input type="file" id="fileInput" class="button"  accept=".txt,.json" style="display:none;">
                </div>
                <!-- Baixar -->
                <div class="col-md-12 col-lg-4 mb-5">
                    <div class="button" onclick="salvarQuestionarios()">
                           <div><i class="fa-solid fa-download"></i> Baixar</div>
                    </div>
                </div>
            </div>   
            <!-- Titulo -->     
            <div class="row">
                <div class="col-12 mt-5">
                    <h2>Questionários</h2>
                </div>
            </div>
            <!-- Lista de Questionarios -->
            <div id="row-questionarios" class="row">
                
            </div>
        </div>
    </body>

    <script>
        var listaQuestionariosRecuperada;

        async function inicializar(){
            // Tenta recuperar a lista da sessão
            listaQuestionariosRecuperada = await recuperarListaQuestionarios();

            // Se nao recuperou 
            if (!listaQuestionariosRecuperada || listaQuestionariosRecuperada.length == 0){
                await carregarArquivo(JSON.stringify(questonarioTeste));

                // Utiliza a lista salva
                listaQuestionariosRecuperada = await recuperarListaQuestionarios();
            }

            listarQuestionarios(listaQuestionariosRecuperada);
        }

        inicializar();
       
        // Listar questionarios disponiveis para fazer
        function listarQuestionarios(listaQuestionarios){
            var html = '';

            for(let i = 0; i < listaQuestionariosRecuperada.length; i++){
                html += `
                    <div class="col-12 mb-4">
                        <div class="btn-lista">
                            <!-- Titulo do Questionario -->
                            <div class="button btn-lista-txt" onclick="iniciarQuestionario(${listaQuestionariosRecuperada[i].id})"><div>${listaQuestionariosRecuperada[i].name}     - ${listaQuestionariosRecuperada[i].data.length}</div></div>
                            <!-- Btn editar questionario -->
                            <div class="button btn-lista-icon" onclick="editarQuestionario(${listaQuestionariosRecuperada[i].id})"><i class="fa-solid fa-pen-to-square"></i></div>        
                        </div>
                    </div>
                `;
            }

            $("#row-questionarios").html(html);
        }

        // Iniciar questionario escolhido
        function iniciarQuestionario(i){
            // Salva o questionario na sessão
            salvarItemSessao(NOME_QUESTIONARIO, i);

            // Abre a página de fazer questionario
            window.location.href = "questionario.html";
        }

        // Abre questionario para ediçao
        function editarQuestionario(i){
            // Se um questionario for selecionado
            if (i != null)
                // Salva o questionario na sessão
                salvarItemSessao(NOME_QUESTIONARIO, i);
            else
                salvarItemSessao(NOME_QUESTIONARIO, null);

            // Abre a página de ediçao
            window.location.href = "questionarioEditar.html";
        }

        const fileInput = document.getElementById('fileInput');

        const reader = new FileReader();

        reader.onload = (e) => {
            var dadosArquivo = e.target.result;
            
            carregarArquivo(dadosArquivo);

            // Or, if you want to display an image:
            // if (file.type.startsWith('image/')) {
            //   const img = document.createElement('img');
            //   img.src = e.target.result;
            //   fileContentDiv.appendChild(img);
            // }
        };

        async function carregarArquivo(dadosArquivo){
            var listaCarregada = JSON.parse(dadosArquivo);

            if (listaCarregada){
                // Se é uma lista
                if (Array.isArray(listaCarregada)){
                    // Atualiza Database para incluir os itens da lista
                    for(let item of listaCarregada){
                        // Tira o id para adicionar como um novo item
                        delete item.id;

                        // Adicionar item no DB
                        await atualizarQuestionarioDB(item);
                    }
                }
                // Se é um único questionário
                else {
                    // Atualiza Database para incluir o questionario

                    // Tira o id para adicionar como um novo item
                    delete listaCarregada.id;

                    // Adicionar item no DB
                    await atualizarQuestionarioDB(listaCarregada);
                }

                // Atualizar lista recuperada
                listaQuestionariosRecuperada = listaCarregada;
                await inicializar();
            }
        }

        reader.onerror = (e) => {
            console.log("Error reading file: " + e.target.error.message);
        }

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];

            if (file) {
                // // Choose how to read the file
                // if (file.type.startsWith('image/')) {
                //     reader.readAsDataURL(file); // For images or other binary data
                // } else {
                    reader.readAsText(file);    // For text files
                // }
            } else {
                console.log( "No file selected.");
            }
        });

        function salvarQuestionarios(){
            //console.log(listaQuestionariosRecuperada);
            //baixar(listaQuestionariosRecuperada);
            baixarDB();
        }
    </script>
</html>
