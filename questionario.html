<!DOCTYPE html>
<html>
    <head>
        <!-- Jquery -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

        <!-- bootstrap -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

        <!-- font awesome -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        
        <!-- css -->
        <link rel="stylesheet" href="style.css">

        <!-- Imports -->
        <script type="text/javascript" src="questionario.js"></script>
        <script type="text/javascript" src="db.js"></script>
    </head>
    <body>
        <!-- TELA responder questionario ---------------------------------------------------------------------------------------------------------------------------------------------------- -->
        <div id="responder-questionario" class="container mt-5">
            <h1 id="titulo-questionario" style="color: gray">

            </h1>
            <!-- Texto da Pergunta -->
            <div class="row" style="margin-top: 2vh;margin-bottom: 2vh;">
                <div class="col-12 mb-1">
                    <div id="pergunta" style="font-weight:400">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua?</div>
                </div>
                <!-- img pergunta -->
                <div clas="col-12 mb-3">
                    <img id="pergunta-img" src="" >
                </div>
            </div>
            <!-- Escondido -->
            <div id="area-resposta-escondida" class="row" style="display:none;">
                <div class="col-12 mb-3">
                    <div id="card-revelar-resposta" class="card-resposta sombra" onclick="revelarEscondida()">
                        <div>
                            猫
                        </div>
                    </div>
                    <div id="resposta-escondida" style="display:none;">
                        Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua?
                    </div>
                </div>
            </div>
            <!-- Alternativas -->
            <div id="row-alternativas" class="row" style="padding-top: 10px;padding-bottom: 10px;border-radius: 5px;">
                <div class="col-12">
                    <div class="btn-lista">
                        <div class="button button-selected btn-lista-txt">Resposta 1</div>    
                    </div>
                </div>
            </div>
            <!-- Explicaçao resposta -->
            <div id="row-explicacao" class="row dica" style="padding-top: 10px;padding-bottom: 10px;border-radius: 5px;">
                <div class="col-12">
                    <div id="explicaco-pergunta">
                        Dica aqui
                    </div>
                </div>
                 <!-- img explicação -->
                 <div clas="col-12 mb-3">
                    <img id="explicacao-img" src="" >
                </div>
            </div>
            <!-- botoes inferiores -->
             <div class="row mt-3">
                 <!-- Botoes Voltar Pergunta -->
                <div class="col-sm-6 my-2">
                    <div class="button button-icon" onclick="mudarQuestao(iQuestao-1);">
                        <i class="fa-solid fa-chevron-left"></i>
                    </div>
                </div>
                <!-- Botoes Avançar Pergunta Col-->
                <div class="col-sm-6 my-2">
                    <div class="button button-icon" onclick="mudarQuestao(iQuestao+1);">
                        <i class="fa-solid fa-chevron-right"></i>
                    </div>
                </div>
                <!-- Btn Sair -->
                <div class="col-sm-12 col-md-6 my-2">
                    <div class="button m-auto" onclick="finalizarQuestionario()">
                        <div><i class="fa-solid fa-person-walking-arrow-right"></i> Terminar</div>
                    </div>
                </div>
                
                <!-- Btn Responder Pergunta -->
                <div class="col-sm-12 col-md-6 my-2">
                    <div id="btn-responder" class="button m-auto" onclick="avancarQuestionario()">
                        <div ><i class="fa-solid fa-check"></i> Responder</div>
                    </div>
                </div>
                 <!-- Paginaçao -->
                 <div class="col-sm-12 col-md-12 my-2">
                    <div style="height: 100%;display: flex;">
                        <div id="paginacao-questionario" class="border-label">10/60</div>
                    </div>
                </div>
             </div>
        </div>
        <!-- Tela FIM ---------------------------------------------------------------------------------------------------------------------------------------------------- -->
        <div id="tela-fim" class="container mt-5">
            <div class="row">
                <!-- Lbl Corretas -->
                <div class="col-12 mt-2">
                    <div style="height: 100%;display: flex;">
                        <div id="contagem-corretas" class="border-label bg-correta">10 Corretas</div>
                    </div>
                </div>
                <!-- Lbl Erradas -->
                <div class="col-12 mt-2">
                    <div style="height: 100%;display: flex;">
                        <div id="contagem-erradas" class="border-label bg-errada">10 Erradas</div>
                    </div>
                </div>
                <!-- Lbl Não Respondidas-->
                <div class="col-12 mt-2">
                    <div style="height: 100%;display: flex;">
                        <div id="contagem-nao-respondidas" class="border-label">10 Não Respondidas</div>
                    </div>
                </div>
                <!-- Lbl Percentual -->
                <div class="col-12 mt-2">
                    <div style="height: 100%;display: flex;">
                        <div id="contagem-percentual" class="border-label">Acertou 50% das respondidas</div>
                    </div>
                </div>
            </div>
            <!-- botoes inferiores -->
            <div class="row mt-3">
                <!-- Voltar página -->
                <div class="col-md-12 col-lg-2 my-2">
                    <div class="button button-icon" onclick="irParaHome()">
                        <i class="fa-solid fa-house"></i>
                    </div>
                </div>
                <!-- Btn Refazer Erradas-->
                <div id="btn-refazer" class="col-md-12 col-lg my-2">
                    <div class="button" onclick="refazerErradas()">
                        <div><i class="fa-solid fa-microscope"></i> Refazer Erradas</div>
                    </div>
                </div>
                <!-- Btn Refazer Questionario-->
                <div class="col-md-12 col-lg my-2">
                    <div class="button" onclick="refazerQuestionario()">
                        <div><i class="fa-solid fa-repeat"></i> Refazer tudo</div>
                    </div>
                </div>
            </div>
        </div>
    </body>

    <script>
        var questionarioCopia = null;
        var questionarioRecuperado = null;

        var perguntaAtual = null;
        var perguntasRegistradas = []; // {id: null, selecionadas: [], respondida: false} 
        
        var iQuestao = -1;
        var limiteQuestionario = 0;
        var inverterQuestionario = false;

        document.onkeypress = function (e) {
            //e = e || window.event;
            if (e.keyCode == 32){
                avancarQuestionario();
            }
        };

        async function iniciarPaginaDeQuestionario(){
            // Pega o questioanrio da sessão
            //questionarioRecuperado = await getQuestionario(recuperarQuestionariosSessao(NOME_QUESTIONARIO));
            questionarioRecuperado = await tryRetornarItemDeUmaTabela(nomeTabelaQuestionario, recuperarQuestionariosSessao(NOME_QUESTIONARIO));

            limiteQuestionario = sessionStorage.getItem(LIMITE_PERGUNTAS);
            inverterQuestionario = sessionStorage.getItem(OPCAO_INVERTER);
            
            if (limiteQuestionario && Number(limiteQuestionario) != 0){
                // remover questoes desnecessárias
                let num = Number(limiteQuestionario);

                // Se tem itens a serem removidos
                if (questionarioRecuperado.data.length > limiteQuestionario){
                    if (inverterQuestionario == 'false'){
                        // remove os itens desnecessários
                        questionarioRecuperado.data.splice(limiteQuestionario);
                    }
                    else {
                        questionarioRecuperado.data = questionarioRecuperado.data.splice(limiteQuestionario*-1);
                        console.log("invertendo");
                    }
                }
            }
                
            //console.log(limiteQuestionario);

            if (questionarioRecuperado != null)
                iniciarQuestionarioRecuperado();
            else
                alert('Não conseguiu recuperar o questionario');
        }

        iniciarPaginaDeQuestionario();

        function refazerQuestionario(){
            iniciarPaginaDeQuestionario();
            // for(let item of questionarioRecuperado.data){
            //     item.respondida = false;

            //     for (let alternativa of item.data){
            //         alternativa.escolhida = false;
            //     }
            // }

            // iniciarQuestionarioRecuperado();
        }

        // Inicia um novo questionario
        function iniciarQuestionarioRecuperado(){
            // Titulo
            $("#titulo-questionario").html(questionarioRecuperado.name);

            // Aleatoriza
            aleatorizarQuestionario(questionarioRecuperado);

            // Esconder tela fim
            $("#tela-fim").css("display", "none");
            $("#responder-questionario").css('display', 'block');

            // Limpar tela inicio
            limparTelas();

            // Aleatorizar todas as questoes e alternativas
            iQuestao = 0;
 
            // Exibir primeira questao
            var pergunta = questionarioRecuperado.data[iQuestao];
            console.log(pergunta);
            exibirQuestao(pergunta);
        }

        // Limpa os dados da tela
        function limparTelas(){
            // Tela inicial
            $("#row-alternativas").html("");
            $("#pergunta").html("");
            $("#paginacao-questionario").html("0/0");

            // Tela fim
            $("#contagem-corretas").html("");
            $("#contagem-erradas").html("");
            $("#contagem-nao-respondidas").html("");
            $("#contagem-percentual").html("");
        }

        async function exibirQuestao(idPergunta){
            // Recuperar pergunta
            perguntaAtual = await tryRetornarItemDeUmaTabela(nomeTabelaPerguntas, idPergunta);

            // Se não conseguiu recuperar a pergunta
            if (!perguntaAtual)
                return;

            // Aleatorizar itens da pergunta
            perguntaAtual.data = aleatorizarItens(perguntaAtual.data);

            // Titulo da pergunta
            $("#pergunta").html(perguntaAtual.name.replaceAll("\n","<br />"));

            $("#pergunta-img").attr('src', perguntaAtual.img ? perguntaAtual.img : "");

            // Dica
            $(".dica").css("display", "none");

            // Resposta Escondida
            $("#area-resposta-escondida").css('display', perguntaAtual.escondida ? 'block' : 'none');
            $("#card-revelar-resposta").css('display','flex');
            $("#resposta-escondida").css('display','none');

            if (perguntaAtual.escondida)
                $("#resposta-escondida").html(perguntaAtual.escondida.replaceAll("\n","<br />"));
            

            // Alternativas
            var alternativas = '';

            for(let item of perguntaAtual.data){
                let temDica = "";

                if (item.dica || item.imgExplicacao){
                    temDica = '<div class="dica">';

                    if (item.dica){
                        temDica += `<div> ${item.dica} </div>`;
                    }

                    if (item.imgExplicacao){
                        temDica += '<img src="'+ item.imgExplicacao + '">';
                    }

                    temDica += '</div>';
                }
                  


                alternativas += `
                    <div class="col-12 mb-4">
                        <div id="alternativa-${item.id}" class="btn-lista" onclick="selecionarNovaAlternativa(${item.id})">
                            <div class="button  btn-lista-txt">
                                <div class="alternativa">
                                    ${item.name ? item.name.replaceAll("\n","<br />") + "</br>" : ""}
                                    ${item.img ? '<img src="'+ item.img + '">' : ""}
                                </div>
                            </div>    
                          
                        </div>
                          ${temDica}
                    </div>`
            }

            $("#row-alternativas").html(alternativas);

            // dicas
            if ( perguntaAtual.dica)
                $("#explicaco-pergunta").html( perguntaAtual.dica.replaceAll("\n","<br />"));
            else
                $("#explicaco-pergunta").html("");

            $("#explicacao-img").attr('src', perguntaAtual.imgExplicacao ? perguntaAtual.imgExplicacao : "");

            selecionarAlternativa();

            // Paginação
            alterarPaginacao();
        }

        function mudarQuestao(iNovaAlternativa){
            // Existe pergunta ?
            if (iNovaAlternativa < questionarioRecuperado.data.length && iNovaAlternativa >= 0){
                // Mudar questao
                iQuestao = iNovaAlternativa;
                var pergunta = questionarioRecuperado.data[iQuestao];
                exibirQuestao(pergunta);
            }
            // Já respondeu tudo?
            else
                return;
        }

        function avancarQuestionario(){
            // Se a alternativa ainda nao foi revelada
            if (!jaRevelada()){
                console.log(`A`);
                console.log(jaRevelada());
                revelarEscondida();
            }
            // Se ainda nao foi respondida
            else if(!jaRespondida()){
                console.log(`B`);
                responderQuestao();
                }
            else if (iQuestao + 1 < questionarioRecuperado.data.length){
                console.log(`C`);
                // Se a alternativa já foi respondida e ainda tem questoes a responder
                mudarQuestao(iQuestao + 1); 
            }
            else
                // Se nao tem mais questoes pra responder
                finalizarQuestionario();

                console.log(`D`);
        }

        function selecionarNovaAlternativa(idAlternativa){
            // Verificar se a questao já foi repsondida
            if (jaRespondida())
                return;

            var isMultiplaEscolha = perguntaAtual.multiplaEscolha;
            var registro = retornarRegistroAtual();

            // Não é multipla escolha
            if (!isMultiplaEscolha){
                // Limpa campo
                registro.selecionadas = [];  
            }

            
            for(let alternativa of perguntaAtual.data){
                //var escolhida = alternativa.id == idAlternativa;
                if (!isMultiplaEscolha && alternativa.id == idAlternativa){
                    console.log(`ENCONTROU!`);
                    registro.selecionadas = [alternativa.id];
                }
                else if (alternativa.id == idAlternativa){
                    let i = registro.selecionadas.findIndex( x => x.idAlternativa);

                    if (i != -1)
                        // remove
                        registro.selecionadas.splice(i, 1);
                    else
                        // Adiciona
                        registro.selecionadas.push(alternativa.id);

                    // alternativa.escolhida = !alternativa.escolhida;
                }
            }
                    

            selecionarAlternativa();
        }

        // --------------------- registro de respostas ------------------------------------------
        function buscarIndiceRespondidas(idAlternativa){
            let i = perguntasRegistradas.findIndex( x => x.id == idAlternativa);

            if (i == -1){
                perguntasRegistradas.push({
                    id: idAlternativa, 
                    selecionadas: [], 
                    respondida: false
                })

                i = perguntasRegistradas.length - 1;
            }

            return i;
        }

        function retornarRegistroAtual(id){
            let i = buscarIndiceRespondidas(id ? id : perguntaAtual ? perguntaAtual.id : null);
            var registro = perguntasRegistradas[i];
            return registro;
        }

         // --------------------- X X X ------------------------------------------
        function selecionarAlternativa(){
            if (jaRespondida())
                sinalizarAlternativaRespondida();
            else {
                var respondida = false;
                var registro = retornarRegistroAtual();

                // Registra alternativa selecionada
                for(let alternativa of perguntaAtual.data){
                    if (registro.selecionadas.includes(alternativa.id)){
                        // Coloca cor na alternativa selecionada
                        $("#alternativa-"+alternativa.id + " > div").addClass('button-selected');

                        respondida = true;
                    }
                    else {
                        // Limpa cores das outras alternativas
                        $("#alternativa-"+alternativa.id + " > div").removeClass('button-selected');
            
                       
                    }
                }
            }

             // Muda cor do botão responder
             mudarBotaoResponder();
        }

        function responderQuestao(){
            // Verificar se a questão já foi respondida
            if (jaRespondida() || retornarRegistroAtual().selecionadas.length == 0){
                return;
            }

            // trava alternativa (já respondida)
            retornarRegistroAtual().respondida = true;

            sinalizarAlternativaRespondida();

            mostrarDica();
        }

        function sinalizarAlternativaRespondida(){
            var registro = retornarRegistroAtual();

            for(let item of perguntaAtual.data){
                var selecionada = registro.selecionadas.includes(item.id);

                if (item.correta && selecionada)
                    // Pinta alternativa correta
                    $(`#alternativa-${item.id} > div`).addClass("bg-correta");
                else if (item.correta && !selecionada)
                    $(`#alternativa-${item.id} > div`).addClass("button-selected");
                else if (!item.correta && selecionada)
                    $(`#alternativa-${item.id} > div`).addClass("bg-errada");
            }

            mudarBotaoResponder();
        }

        function mostrarDica(){
            $(".dica").css("display", "block");
            //$(".dica").css("display", questionarioRecuperado.data[iQuestao].dica || questionarioRecuperado.data[iQuestao].imgExplicacao? "block" : "none");

            
        }

        function finalizarQuestionario(){
            let respostas = {
                corretas: 0,
                incorretas: 0,
                respondidas: 0,
                naoRespondidas: 0
            }

            // Verificar se o questionario foi todo respondido
            for(let item of questionarioRecuperado.data){
                // A pergunta foi respondida?
                if (!item.respondida)
                     // Extrair número de perguntas não respondidas
                    respostas.naoRespondidas++;
                else {
                    console.log("Chamando acertou " + item.id);
                    var acertou = acertouQuestao(item.id);

                    
                    // for(let alternativa of item.data){
                    //     if (alternativa.escolhida && alternativa.correta){
                    //         acertou = true;
                    //         break;
                    //     }
                    // }

                    // Extrair número de preguntas corretas e erradas
                    if (acertou)
                        respostas.corretas++;
                    else
                        respostas.incorretas++;

                    respostas.respondidas++;
                }
            }

            // Se errou alguma pergunta, mostrar botao para refazer
            $("#btn-refazer").css("display", respostas.incorretas > 0 ? "block": "none");
           
            // Calcular percentual de acerto do questionário  
            console.log(respostas);
            mostrarTelaFinal();

            $("#contagem-corretas").html(`${respostas.corretas}/${respostas.respondidas} Corretas`);
            $("#contagem-erradas").html(`${respostas.incorretas}/${respostas.respondidas} Erradas`);
            $("#contagem-nao-respondidas").html(`${respostas.naoRespondidas} Não Respondidas`);
            $("#contagem-percentual").html(`${(respostas.corretas/respostas.respondidas*100).toFixed(0)} % de acerto`);            
        };

        function mostrarTelaFinal(){
            limparTelas();

            // Esconder tela inicio
            $("#responder-questionario").css("display", "none");

            $("#tela-fim").css('display', 'block');
        }

        function alterarPaginacao(){
            $("#paginacao-questionario").html(`${iQuestao+1}/${questionarioRecuperado.data.length}`);
        }

        function mudarBotaoResponder(){
            var etapa = 0;
            var correta = false;

            let iSelecionada = perguntaAtual.data.findIndex( x=> x.escolhida);

            var registro = retornarRegistroAtual();

            // Se nenhuma alternativa foi selecionada
            if (registro.selecionadas.length == 0)
                // Desabilita o botão de avançar
                $("#btn-responder").addClass("btn-disabled");
            else {
                // Habilita o botão de avançar
                $("#btn-responder").removeClass("btn-disabled");
                etapa = 1;
            }

            // Foi respondido?
            if (registro.respondida){
                etapa = 2;

                var correta = acertouQuestao(perguntaAtual.id);
                $("#btn-responder").addClass(correta ? "bg-correta" : "bg-errada");


                // if (acertou){
                //     $("#btn-responder").addClass("bg-correta");
                //     correta = true;
                // }
                // else {
                //     $("#btn-responder").addClass("bg-errada");
                //     correta = false;
                // }
            }
            else
                $("#btn-responder").removeClass("bg-errada bg-correta");

                switch(etapa){
                    case 0:
                        $("#row-alternativas").css({background: "unset"});
                        $("#btn-responder > div").html("<i class='fa-regular fa-hand-pointer'></i> Selecione"); 
                        break;
                    case 1:
                        $("#row-alternativas").css({background: "unset"});
                        $("#btn-responder > div").html("<i class='fa-solid fa-check'></i> Responder"); 
                        break;
                    case 2:
                        $("#row-alternativas").css({background: `${correta ? '#b7f9d1' : '#ffdcdc'}`}); 
                        $("#btn-responder > div").html("<i class='fa-solid fa-check-double'></i> Avançar"); 
                        break;
                }
        }

        // Verificar se a dica foi revelada
        function jaRevelada(){
            return (perguntaAtual && perguntaAtual.escondida) ? ($("#resposta-escondida").css("display") == "block") : true
        }

        // Verificar se a questao já foi repsondida
        function jaRespondida(){
            // let i = buscarIndiceRespondidas(perguntaAtual.id);

            // return i != -1 && perguntasRegistradas[i].respondida

            //return questionarioRecuperado.data[iQuestao] ? questionarioRecuperado.data[iQuestao].respondida : false
            return retornarRegistroAtual().respondida;
        }

        // retorna um array com as alternativas consideradas corretas
        async function getAlternativasCorretas(id){
            // Recupera a pergunta pelo id

            var pergunta = await tryRetornarItemDeUmaTabela(nomeTabelaPerguntas, id);

            var corretas = [];

            // Para cada alternativa
            if (pergunta)
                for(let item of pergunta.data){
                    // Se for uma alternativa correta
                    if (item.correta)
                        // Adiciona ao array
                        corretas.push(item.id);
                }
            // corretas.sort();

            return corretas;
        }

        function compararArray(arrA, arrB){
            if (!arrA || !arrB || arrA.length != arrB.length)
                return false;

                console.log(1);
            for(let i = 0; i < arrA.length; i++){
                if (arrA[i] != arrB[i])
                    return false;
            }
            console.log(2);
            return true;
        }

        async function acertouQuestao(id){
            // Recupera as respostas registradadas de uma questão
            var registro = retornarRegistroAtual(id);

            // Recupera um array com as alternativas corretas de uma questão
            let arrayCorretas = getAlternativasCorretas(id);

            return compararArray(registro.selecionadas, arrayCorretas);
        }

        function irParaHome(){
            window.location.href = "index.html";
        }

        function refazerErradas(){
            var questionarioErradas = {name: questionarioRecuperado.name + " - Correções", data: [], id: questionarioRecuperado.id};

            // Adicionar questoes
            for(let item of questionarioRecuperado.data){
                // // Se nao respondeu
                // if (!item.respondida){
                //     // Adicionar
                //     questionarioErradas.data.push(item);
                // }
                // else {
                    // // Se respondeu errado
                    // let iCorreta = item.data.findIndex( x=> x.correta);

                    // Se respondeu errado OU nao tem resposta
                    //if (iCorreta != -1 && !item.data[iCorreta].escolhida){
                    if (!acertouQuestao(item.id)){
                        // Limpa a resposta
                        for(let alternativas of item.data)
                            alternativas.escolhida = false;

                        // Adicionar
                        item.respondida = false;
                        questionarioErradas.data.push(item);
                    }
                //}
            }

            questionarioRecuperado = questionarioErradas;

            iniciarQuestionarioRecuperado();
        }
   
        function revelarEscondida(){
            $("#card-revelar-resposta").css('display','none');
            $("#resposta-escondida").css('display','block');
        }
   </script>
</html>
