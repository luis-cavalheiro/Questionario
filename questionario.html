<!DOCTYPE html>
<html>
    <head>
        <!-- Jquery -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

        <!-- bootstrap -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

        <!-- font awesome -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        
        <!-- css -->
        <link rel="stylesheet" href="style.css">

        <!-- Imports -->
        <script type="text/javascript" src="questionario.js"></script>
        <script type="text/javascript" src="db.js"></script>
    </head>
    <body>
        <!-- TELA responder questionario ---------------------------------------------------------------------------------------------------------------------------------------------------- -->
        <div id="responder-questionario" class="container mt-5">
            <h1 id="titulo-questionario" style="color: gray">

            </h1>
            <!-- Texto da Pergunta -->
            <div class="row" style="margin-top: 2vh;margin-bottom: 2vh;">
                <div class="col-12 mb-1">
                    <div id="pergunta" style="font-weight:400">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua?</div>
                </div>
                <!-- img pergunta -->
                <div clas="col-12 mb-3">
                    <img id="pergunta-img" src="" >
                </div>
            </div>
            <!-- Escondido -->
            <div id="area-resposta-escondida" class="row" style="display:none;">
                <div class="col-12 mb-3">
                    <div id="card-revelar-resposta" class="card-resposta sombra" onclick="revelarEscondida()">
                        <div>
                            猫
                        </div>
                    </div>
                    <div id="resposta-escondida" style="display:none;">
                        Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua?
                    </div>
                </div>
            </div>
            <!-- Alternativas -->
            <div id="row-alternativas" class="row" style="padding-top: 10px;padding-bottom: 10px;border-radius: 5px;">
                <div class="col-12">
                    <div class="btn-lista">
                        <div class="button button-selected btn-lista-txt">Resposta 1</div>    
                    </div>
                </div>
            </div>
            <!-- Explicaçao resposta -->
            <div id="row-explicacao" class="row" style="padding-top: 10px;padding-bottom: 10px;border-radius: 5px;">
                <div class="col-12">
                    <div id="explicaco-pergunta" class="dica">
                        Dica aqui
                    </div>
                </div>
            </div>
            <!-- botoes inferiores -->
             <div class="row mt-3">
                 <!-- Botoes Voltar Pergunta -->
                <div class="col-sm-6 my-2">
                    <div class="button button-icon" onclick="mudarQuestao(iQuestao-1);">
                        <i class="fa-solid fa-chevron-left"></i>
                    </div>
                </div>
                <!-- Botoes Avançar Pergunta Col-->
                <div class="col-sm-6 my-2">
                    <div class="button button-icon" onclick="mudarQuestao(iQuestao+1);">
                        <i class="fa-solid fa-chevron-right"></i>
                    </div>
                </div>
                <!-- Btn Sair -->
                <div class="col-sm-12 col-md-6 my-2">
                    <div class="button m-auto" onclick="finalizarQuestionario()">
                        <div><i class="fa-solid fa-person-walking-arrow-right"></i> Terminar</div>
                    </div>
                </div>
                
                <!-- Btn Responder Pergunta -->
                <div class="col-sm-12 col-md-6 my-2">
                    <div id="btn-responder" class="button m-auto" onclick="avancarQuestionario()">
                        <div ><i class="fa-solid fa-check"></i> Responder</div>
                    </div>
                </div>
                 <!-- Paginaçao -->
                 <div class="col-sm-12 col-md-12 my-2">
                    <div style="height: 100%;display: flex;">
                        <div id="paginacao-questionario" class="border-label">10/60</div>
                    </div>
                </div>
             </div>
        </div>
        <!-- Tela FIM ---------------------------------------------------------------------------------------------------------------------------------------------------- -->
        <div id="tela-fim" class="container mt-5">
            <div class="row">
                <!-- Lbl Corretas -->
                <div class="col-12 mt-2">
                    <div style="height: 100%;display: flex;">
                        <div id="contagem-corretas" class="border-label bg-correta">10 Corretas</div>
                    </div>
                </div>
                <!-- Lbl Erradas -->
                <div class="col-12 mt-2">
                    <div style="height: 100%;display: flex;">
                        <div id="contagem-erradas" class="border-label bg-errada">10 Erradas</div>
                    </div>
                </div>
                <!-- Lbl Não Respondidas-->
                <div class="col-12 mt-2">
                    <div style="height: 100%;display: flex;">
                        <div id="contagem-nao-respondidas" class="border-label">10 Não Respondidas</div>
                    </div>
                </div>
                <!-- Lbl Percentual -->
                <div class="col-12 mt-2">
                    <div style="height: 100%;display: flex;">
                        <div id="contagem-percentual" class="border-label">Acertou 50% das respondidas</div>
                    </div>
                </div>
            </div>
            <!-- botoes inferiores -->
            <div class="row mt-3">
                <!-- Voltar página -->
                <div class="col-md-12 col-lg-2 my-2">
                    <div class="button button-icon" onclick="irParaHome()">
                        <i class="fa-solid fa-house"></i>
                    </div>
                </div>
                <!-- Btn Refazer Erradas-->
                <div id="btn-refazer" class="col-md-12 col-lg my-2">
                    <div class="button" onclick="refazerErradas()">
                        <div><i class="fa-solid fa-microscope"></i> Refazer Erradas</div>
                    </div>
                </div>
                <!-- Btn Refazer Questionario-->
                <div class="col-md-12 col-lg my-2">
                    <div class="button" onclick="refazerQuestionario()">
                        <div><i class="fa-solid fa-repeat"></i> Refazer tudo</div>
                    </div>
                </div>
            </div>
        </div>
    </body>

    <script>
        var questionarioCopia = null;
        var questionarioRecuperado = null;
        var iQuestao = -1;
        var limiteQuestionario = 0;

        document.onkeypress = function (e) {
            //e = e || window.event;
            if (e.keyCode == 32){
                avancarQuestionario();
            }
        };

        async function iniciarPaginaDeQuestionario(){
            // Pega o questioanrio da sessão
            questionarioRecuperado = await getQuestionario(recuperarQuestionariosSessao(NOME_QUESTIONARIO));

            limiteQuestionario = sessionStorage.getItem(LIMITE_PERGUNTAS);
            
            if (limiteQuestionario && Number(limiteQuestionario) != 0){
                // remover questoes desnecessárias
                let num = Number(limiteQuestionario);

                // Se tem itens a serem removidos
                if (questionarioRecuperado.data.length > limiteQuestionario)
                    // remove os itens desnecessários
                    questionarioRecuperado.data.splice(limiteQuestionario);
            }
                
            console.log(limiteQuestionario);

            if (questionarioRecuperado != null)
                iniciarQuestionarioRecuperado();
            else
                alert('Não conseguiu recuperar o questionario');
        }

        iniciarPaginaDeQuestionario();

        function refazerQuestionario(){
            iniciarPaginaDeQuestionario();
            // for(let item of questionarioRecuperado.data){
            //     item.respondida = false;

            //     for (let alternativa of item.data){
            //         alternativa.escolhida = false;
            //     }
            // }

            // iniciarQuestionarioRecuperado();
        }

        // Inicia um novo questionario
        function iniciarQuestionarioRecuperado(){
            // Titulo
            $("#titulo-questionario").html(questionarioRecuperado.name);

            // Aleatoriza
            aleatorizarQuestionario(questionarioRecuperado);

            // Esconder tela fim
            $("#tela-fim").css("display", "none");
            $("#responder-questionario").css('display', 'block');

            // Limpar tela inicio
            limparTelas();

            // Aleatorizar todas as questoes e alternativas
            iQuestao = 0;
 
            // Exibir primeira questao
            var pergunta = questionarioRecuperado.data[iQuestao];
            console.log(pergunta);
            exibirQuestao(pergunta);
        }

        // Limpa os dados da tela
        function limparTelas(){
            // Tela inicial
            $("#row-alternativas").html("");
            $("#pergunta").html("");
            $("#paginacao-questionario").html("0/0");

            // Tela fim
            $("#contagem-corretas").html("");
            $("#contagem-erradas").html("");
            $("#contagem-nao-respondidas").html("");
            $("#contagem-percentual").html("");
        }

        function exibirQuestao(pergunta){
            // Titulo da pergunta
            $("#pergunta").html(pergunta.name.replaceAll("\n","<br />"));

            $("#pergunta-img").attr('src', pergunta.img ? pergunta.img : "");

            // Dica
            $(".dica").css("display", "none");

            // Resposta Escondida
            $("#area-resposta-escondida").css('display', pergunta.escondida ? 'block' : 'none');
            $("#card-revelar-resposta").css('display','flex');
            $("#resposta-escondida").css('display','none');

            if (pergunta.escondida)
                $("#resposta-escondida").html(pergunta.escondida.replaceAll("\n","<br />"));
            

            // Alternativas
            var alternativas = '';

            for(let item of pergunta.data){
                let temDica = "";

                if (item.dica)
                    temDica = `<div class="dica"> ${item.dica} </div>`;

                alternativas += `
                    <div class="col-12 mb-4">
                        <div id="alternativa-${item.id}" class="btn-lista" onclick="selecionarNovaAlternativa(${item.id})">
                            <div class="button  btn-lista-txt">
                                <div class="alternativa">
                                    ${item.name ? item.name.replaceAll("\n","<br />") + "</br>" : ""}
                                    ${item.img ? '<img src="'+ item.img + '">' : ""}
                                </div>
                            </div>    
                          
                        </div>
                          ${temDica}
                    </div>`
            }

            $("#row-alternativas").html(alternativas);

            selecionarAlternativa();

            // Paginação
            alterarPaginacao();
        }

        function mudarQuestao(iNovaAlternativa){
            // Existe pergunta ?
            if (iNovaAlternativa < questionarioRecuperado.data.length && iNovaAlternativa >= 0){
                // Mudar questao
                iQuestao = iNovaAlternativa;
                var pergunta = questionarioRecuperado.data[iQuestao];
                exibirQuestao(pergunta);
            }
            // Já respondeu tudo?
            else
                return;
        }

        function avancarQuestionario(){
            // Se a alternativa ainda nao foi revelada
            if (!jaRevelada()){
                console.log(jaRevelada());
                revelarEscondida();
            }
            // Se ainda nao foi respondida
            else if(!jaRespondida())
                responderQuestao();
            else if (iQuestao + 1 < questionarioRecuperado.data.length)
                // Se a alternativa já foi respondida e ainda tem questoes a responder
                mudarQuestao(iQuestao + 1); 
            else
                // Se nao tem mais questoes pra responder
                finalizarQuestionario();
        }

        function selecionarNovaAlternativa(idAlternativa){
            // Verificar se a questao já foi repsondida
            if (jaRespondida())
                return;

            var isMultiplaEscolha = questionarioRecuperado.data[iQuestao].multiplaEscolha;

            for(let alternativa of questionarioRecuperado.data[iQuestao].data){
                //var escolhida = alternativa.id == idAlternativa;

                if (!isMultiplaEscolha)
                    alternativa.escolhida = alternativa.id == idAlternativa;
                else if (alternativa.id == idAlternativa){
                    console.log("Trocando " + idAlternativa);
                    alternativa.escolhida = !alternativa.escolhida;
                }
            }
                    

            selecionarAlternativa();
        }

        function selecionarAlternativa(){
            if (jaRespondida())
                sinalizarAlternativaRespondida();
            else {
                var respondida = false;

                // Registra alternativa selecionada
                for(let alternativa of questionarioRecuperado.data[iQuestao].data){
                    if (alternativa.escolhida){
                        // Coloca cor na alternativa selecionada
                        $("#alternativa-"+alternativa.id + " > div").addClass('button-selected');

                        respondida = true;
                    }
                    else {
                        // Limpa cores das outras alternativas
                        $("#alternativa-"+alternativa.id + " > div").removeClass('button-selected');
            
                        // Muda cor do botão responder
                        mudarBotaoResponder();
                    }
                }
            }
        }

        function responderQuestao(){
            // Verificar se a questão já foi respondida
            if (jaRespondida() || getAlternativaSelecionada(iQuestao).length == 0){
                return;
            }

            // trava alternativa (já respondida)
            questionarioRecuperado.data[iQuestao].respondida = true;

            sinalizarAlternativaRespondida();

            mostrarDica();
        }

        function sinalizarAlternativaRespondida(){
            for(let item of questionarioRecuperado.data[iQuestao].data){
                if (item.correta && item.escolhida)
                    // Pinta alternativa correta
                    $(`#alternativa-${item.id} > div`).addClass("bg-correta");
                else if (item.correta && !item.escolhida)
                    $(`#alternativa-${item.id} > div`).addClass("button-selected");
                else if (item.escolhida && !item.correta)
                    $(`#alternativa-${item.id} > div`).addClass("bg-errada");
            }

            mudarBotaoResponder();
        }

        function mostrarDica(){
            $(".dica").css("display", questionarioRecuperado.data[iQuestao].dica? "block" : "none");

            if ( questionarioRecuperado.data[iQuestao].dica)
                $("#explicaco-pergunta").html( questionarioRecuperado.data[iQuestao].dica.replaceAll("\n","<br />"));
            else
                $("#explicaco-pergunta").html("");
        }

        function finalizarQuestionario(){
            let respostas = {
                corretas: 0,
                incorretas: 0,
                respondidas: 0,
                naoRespondidas: 0
            }

            // Verificar se o questionario foi todo respondido
            for(let item of questionarioRecuperado.data){
                // A pergunta foi respondida?
                if (!item.respondida)
                     // Extrair número de perguntas não respondidas
                    respostas.naoRespondidas++;
                else {
                    var acertou = acertouQuestao(item.id);

                    
                    // for(let alternativa of item.data){
                    //     if (alternativa.escolhida && alternativa.correta){
                    //         acertou = true;
                    //         break;
                    //     }
                    // }

                    // Extrair número de preguntas corretas e erradas
                    if (acertou)
                        respostas.corretas++;
                    else
                        respostas.incorretas++;

                    respostas.respondidas++;
                }
            }

            // Se errou alguma pergunta, mostrar botao para refazer
            $("#btn-refazer").css("display", respostas.incorretas > 0 ? "block": "none");
           
            // Calcular percentual de acerto do questionário  
            console.log(respostas);
            mostrarTelaFinal();

            $("#contagem-corretas").html(`${respostas.corretas}/${respostas.respondidas} Corretas`);
            $("#contagem-erradas").html(`${respostas.incorretas}/${respostas.respondidas} Erradas`);
            $("#contagem-nao-respondidas").html(`${respostas.naoRespondidas} Não Respondidas`);
            $("#contagem-percentual").html(`${(respostas.corretas/respostas.respondidas*100).toFixed(0)} % de acerto`);            
        };

        function mostrarTelaFinal(){
            limparTelas();

            // Esconder tela inicio
            $("#responder-questionario").css("display", "none");

            $("#tela-fim").css('display', 'block');
        }

        function alterarPaginacao(){
            $("#paginacao-questionario").html(`${iQuestao+1}/${questionarioRecuperado.data.length}`);
        }

        function mudarBotaoResponder(){
            var etapa = 0;
            var correta = false;

            let iSelecionada = questionarioRecuperado.data[iQuestao].data.findIndex( x=> x.escolhida);

            // Uma alternativa foi selecionada?
            if (iSelecionada == -1)
                $("#btn-responder").addClass("btn-disabled");
            else {
                $("#btn-responder").removeClass("btn-disabled");
                etapa = 1;
            }

            // Foi respondido?
            if (questionarioRecuperado.data[iQuestao].respondida){
                etapa = 2;

                var correta = acertouQuestao(questionarioRecuperado.data[iQuestao].id);
                $("#btn-responder").addClass(correta ? "bg-correta" : "bg-errada");


                // if (acertou){
                //     $("#btn-responder").addClass("bg-correta");
                //     correta = true;
                // }
                // else {
                //     $("#btn-responder").addClass("bg-errada");
                //     correta = false;
                // }
            }
            else
                $("#btn-responder").removeClass("bg-errada bg-correta");

                switch(etapa){
                    case 0:
                        $("#row-alternativas").css({background: "unset"});
                        $("#btn-responder > div").html("<i class='fa-regular fa-hand-pointer'></i> Selecione"); 
                        break;
                    case 1:
                        $("#row-alternativas").css({background: "unset"});
                        $("#btn-responder > div").html("<i class='fa-solid fa-check'></i> Responder"); 
                        break;
                    case 2:
                        $("#row-alternativas").css({background: `${correta ? '#b7f9d1' : '#ffdcdc'}`}); 
                        $("#btn-responder > div").html("<i class='fa-solid fa-check-double'></i> Avançar"); 
                        break;
                }
        }

        // Verificar se a dica foi revelada
        function jaRevelada(){
            return (questionarioRecuperado.data[iQuestao] && questionarioRecuperado.data[iQuestao].escondida) ? ($("#resposta-escondida").css("display") == "block") : true
        }

        // Verificar se a questao já foi repsondida
        function jaRespondida(){
            return questionarioRecuperado.data[iQuestao] ? questionarioRecuperado.data[iQuestao].respondida : false
        }

        //  retorna um array com as alternativa selecionadas pelo usuário
        function getAlternativaSelecionada(i){
            var selecionadas = [];

            // pega os ids das alternativas selecionadas
            if (i != -1)
                for(let item of questionarioRecuperado.data[i].data){
                    if (item.escolhida)
                        selecionadas.push(item.id);
                }

            selecionadas.sort();

            return selecionadas;
        }

        // retorna um array com as alternativas consideradas corretas
        function getAlternativasCorretas(i){
            var corretas = [];

            // pega os ids das alternativas selecionadas
            if (i != -1)
                for(let item of questionarioRecuperado.data[i].data){
                    if (item.correta)
                        corretas.push(item.id);
                }

            corretas.sort();

            return corretas;
        }

        function compararArray(arrA, arrB){
            console.log('----------------------');
            console.log(arrA);
            console.log(arrB);

            if (!arrA || !arrB || arrA.length != arrB.length)
                return false;

                console.log(1);
            for(let i = 0; i < arrA.length; i++){
                if (arrA[i] != arrB[i])
                    return false;
            }
            console.log(2);
            return true;
        }

        function acertouQuestao(id){
            let i = questionarioRecuperado.data.findIndex(x => x == id);

            console.log("------------acertou?? " + i);
            let arraySelecionads = getAlternativaSelecionada(i);
            let arrayCorretas = getAlternativasCorretas(i);

            return compararArray(arraySelecionads, arrayCorretas);
        }

        function irParaHome(){
            window.location.href = "index.html";
        }

        function refazerErradas(){
            var questionarioErradas = {name: questionarioRecuperado.name + " - Correções", data: [], id: questionarioRecuperado.id};

            // Adicionar questoes
            for(let item of questionarioRecuperado.data){
                // // Se nao respondeu
                // if (!item.respondida){
                //     // Adicionar
                //     questionarioErradas.data.push(item);
                // }
                // else {
                    // // Se respondeu errado
                    // let iCorreta = item.data.findIndex( x=> x.correta);

                    // Se respondeu errado OU nao tem resposta
                    //if (iCorreta != -1 && !item.data[iCorreta].escolhida){
                    if (!acertouQuestao(item.id)){
                        // Limpa a resposta
                        for(let alternativas of item.data)
                            alternativas.escolhida = false;

                        // Adicionar
                        item.respondida = false;
                        questionarioErradas.data.push(item);
                    }
                //}
            }

            questionarioRecuperado = questionarioErradas;

            iniciarQuestionarioRecuperado();
        }
   
        function revelarEscondida(){
            $("#card-revelar-resposta").css('display','none');
            $("#resposta-escondida").css('display','block');
        }
   </script>
</html>
