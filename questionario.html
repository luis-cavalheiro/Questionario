<!DOCTYPE html>
<html>
    <head>
        <!-- Jquery -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

        <!-- bootstrap -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

        <!-- font awesome -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        
        <!-- css -->
        <link rel="stylesheet" href="style.css">

        <!-- Imports -->
        <script type="text/javascript" src="questionario.js"></script>
    </head>
    <body>
        <!-- TELA responder questionario ---------------------------------------------------------------------------------------------------------------------------------------------------- -->
        <div id="responder-questionario" class="container mt-5">
            <h1 id="titulo-questionario" style="color: gray">

            </h1>
            <!-- Texto da Pergunta -->
            <div class="row">
                <div class="col-12 mb-3">
                    <div id="pergunta">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua?</div>
                </div>
            </div>
            <!-- Alternativas -->
            <div id="row-alternativas" class="row" style="padding-top: 10px;padding-bottom: 10px;">
                <div class="col-12">
                    <div class="btn-lista">
                        <div class="button button-selected btn-lista-txt">Resposta 1</div>    
                    </div>
                </div>
            </div>

            <!-- botoes inferiores -->
             <div class="row mt-3">
                 <!-- Botoes Voltar Pergunta -->
                <div class="col-sm-12 col-md-1 my-2">
                    <div class="button button-icon" onclick="mudarQuestao(iQuestao-1);">
                        <i class="fa-solid fa-chevron-left"></i>
                    </div>
                </div>
                <!-- Botoes Avançar Pergunta Col-->
                <div class="col-sm-12 col-md-1 my-2">
                    <div class="button button-icon" onclick="mudarQuestao(iQuestao+1);">
                        <i class="fa-solid fa-chevron-right"></i>
                    </div>
                </div>
                <!-- Btn Sair -->
                <div class="col-sm-12 col-md-2 my-2">
                    <div class="button" onclick="finalizarQuestionario()">
                        <div><i class="fa-solid fa-person-walking-arrow-right"></i> Terminar</div>
                    </div>
                </div>
                <!-- Paginaçao -->
                <div class="col-sm-12 col-md my-2">
                    <div style="height: 100%;display: flex;">
                        <div id="paginacao-questionario" class="border-label">10/60</div>
                    </div>
                </div>
                <!-- Btn Responder Pergunta -->
                <div class="col-sm-12 col-md-4 my-2">
                    <div id="btn-responder" class="button" onclick="avancarQuestionario()">
                        <div ><i class="fa-solid fa-check"></i> Responder</div>
                    </div>
                </div>
             </div>
        </div>
        <!-- Tela FIM ---------------------------------------------------------------------------------------------------------------------------------------------------- -->
        <div id="tela-fim" class="container mt-5">
            <div class="row">
                <!-- Lbl Corretas -->
                <div class="col-12 mt-2">
                    <div style="height: 100%;display: flex;">
                        <div id="contagem-corretas" class="border-label bg-correta">10 Corretas</div>
                    </div>
                </div>
                <!-- Lbl Erradas -->
                <div class="col-12 mt-2">
                    <div style="height: 100%;display: flex;">
                        <div id="contagem-erradas" class="border-label bg-errada">10 Erradas</div>
                    </div>
                </div>
                <!-- Lbl Não Respondidas-->
                <div class="col-12 mt-2">
                    <div style="height: 100%;display: flex;">
                        <div id="contagem-nao-respondidas" class="border-label">10 Não Respondidas</div>
                    </div>
                </div>
                <!-- Lbl Percentual -->
                <div class="col-12 mt-2">
                    <div style="height: 100%;display: flex;">
                        <div id="contagem-percentual" class="border-label">Acertou 50% das respondidas</div>
                    </div>
                </div>
            </div>
            <!-- botoes inferiores -->
            <div class="row mt-3">
                <!-- Voltar página -->
                <div class="col-sm-12 col-md-1 my-2">
                    <div class="button button-icon" onclick="irParaHome()">
                        <i class="fa-solid fa-house"></i>
                    </div>
                </div>
                <!-- Btn Refazer Erradas-->
                <div id="btn-refazer" class="col-sm-12 col-md my-2">
                    <div class="button" onclick="refazerErradas()">
                        <div><i class="fa-solid fa-microscope"></i> Refazer Erradas</div>
                    </div>
                </div>
                <!-- Btn Refazer Questionario-->
                <div class="col-sm-12 col-md my-2">
                    <div class="button" onclick="refazerQuestionario()">
                        <div><i class="fa-solid fa-repeat"></i> Refazer tudo</div>
                    </div>
                </div>
            </div>
        </div>
    </body>

    <script>
        var questionarioCopia = null;
        var questionarioRecuperado = null;
        var iQuestao = -1;

        document.onkeypress = function (e) {
            //e = e || window.event;
            if (e.keyCode == 32)
                avancarQuestionario();
        };

        function iniciarPaginaDeQuestionario(){
            // Pega o questioanrio da sessão
            questionarioRecuperado = recuperarQuestionariosSessao(NOME_QUESTIONARIO)

            if (questionarioRecuperado != null)
                iniciarQuestionarioRecuperado();
            else
                alert('Não conseguiu recuperar o questionario');
        }

        iniciarPaginaDeQuestionario();

        function refazerQuestionario(){
            iniciarPaginaDeQuestionario();
            // for(let item of questionarioRecuperado.data){
            //     item.respondida = false;

            //     for (let alternativa of item.data){
            //         alternativa.escolhida = false;
            //     }
            // }

            // iniciarQuestionarioRecuperado();
        }

        // Inicia um novo questionario
        function iniciarQuestionarioRecuperado(){
            // Titulo
            $("#titulo-questionario").html(questionarioRecuperado.name);

            // Aleatoriza
            aleatorizarQuestionario(questionarioRecuperado);

            // Esconder tela fim
            $("#tela-fim").css("display", "none");
            $("#responder-questionario").css('display', 'block');

            // Limpar tela inicio
            limparTelas();

            // Aleatorizar todas as questoes e alternativas
            iQuestao = 0;
 
            // Exibir primeira questao
            var pergunta = questionarioRecuperado.data[iQuestao];
            console.log(pergunta);
            exibirQuestao(pergunta);
        }

        // Limpa os dados da tela
        function limparTelas(){
            // Tela inicial
            $("#row-alternativas").html("");
            $("#pergunta").html("");
            $("#paginacao-questionario").html("0/0");

            // Tela fim
            $("#contagem-corretas").html("");
            $("#contagem-erradas").html("");
            $("#contagem-nao-respondidas").html("");
            $("#contagem-percentual").html("");
        }

        function exibirQuestao(pergunta){
            // Titulo da pergunta
            $("#pergunta").html(pergunta.name);

            // Alternativas
            var alternativas = '';

            for(let item of pergunta.data){
                alternativas += `
                    <div class="col-12">
                        <div id="alternativa-${item.id}" class="btn-lista" onclick="selecionarNovaAlternativa(${item.id})">
                            <div class="button  btn-lista-txt">${item.name}</div>    
                        </div>
                    </div>`
            }

            $("#row-alternativas").html(alternativas);

            selecionarAlternativa();

            // Paginação
            alterarPaginacao();
        }

        function mudarQuestao(iNovaAlternativa){
            // Existe pergunta ?
            if (iNovaAlternativa < questionarioRecuperado.data.length && iNovaAlternativa >= 0){
                // Mudar questao
                iQuestao = iNovaAlternativa;
                var pergunta = questionarioRecuperado.data[iQuestao];
                exibirQuestao(pergunta);
            }
            // Já respondeu tudo?
            else
                return;
        }

        function avancarQuestionario(){
            // Se a alternativa ainda nao foi respondida
            if(!jaRespondida())
                responderQuestao();
            else if (iQuestao + 1 < questionarioRecuperado.data.length)
                // Se a alternativa já foi respondida e ainda tem questoes a responder
                mudarQuestao(iQuestao + 1); 
            else
                // Se nao tem mais questoes pra responder
                finalizarQuestionario();
        }

        function selecionarNovaAlternativa(idAlternativa){
            // Verificar se a questao já foi repsondida
            if (jaRespondida())
                return;

            for(let alternativa of questionarioRecuperado.data[iQuestao].data){
                var escolhida = alternativa.id == idAlternativa;
                alternativa.escolhida = escolhida;
            }

            selecionarAlternativa();
        }

        function selecionarAlternativa(){
            if (jaRespondida())
                sinalizarAlternativaRespondida();
            else {
                var respondida = false;

                // Registra alternativa selecionada
                for(let alternativa of questionarioRecuperado.data[iQuestao].data){
                    if (alternativa.escolhida){
                        // Coloca cor na alternativa selecionada
                        $("#alternativa-"+alternativa.id + " > div").addClass('button-selected');

                        respondida = true;
                    }
                    else {
                        // Limpa cores das outras alternativas
                        $("#alternativa-"+alternativa.id + " > div").removeClass('button-selected');
            
                        // Muda cor do botão responder
                        mudarBotaoResponder();
                    }
                }
            }
        }

        function responderQuestao(){
            // Verificar se a questão já foi respondida
            if (jaRespondida()){
                return;
            }

            // trava alternativa (já respondida)
            questionarioRecuperado.data[iQuestao].respondida = true;

            sinalizarAlternativaRespondida();
        }

        function sinalizarAlternativaRespondida(){
            // Pinta alternativa correta
            let iCorreta = questionarioRecuperado.data[iQuestao].data.findIndex( x => x.correta == true);
            $(`#alternativa-${questionarioRecuperado.data[iQuestao].data[iCorreta].id} > div`).addClass("bg-correta");

            // Se alternativa correta != selecionada, pinta a alternativa selecionada
            if (!questionarioRecuperado.data[iQuestao].data[iCorreta].escolhida){
                // acha alternativa escolhida
                let iEscolhida = questionarioRecuperado.data[iQuestao].data.findIndex( x => x.escolhida == true);

                $(`#alternativa-${questionarioRecuperado.data[iQuestao].data[iEscolhida].id} > div`).addClass("bg-errada");
            }

            mudarBotaoResponder();
        }

        function finalizarQuestionario(){
            let respostas = {
                corretas: 0,
                incorretas: 0,
                respondidas: 0,
                naoRespondidas: 0
            }

            // Verificar se o questionario foi todo respondido
            for(let item of questionarioRecuperado.data){
                // A pergunta foi respondida?
                if (!item.respondida)
                     // Extrair número de perguntas não respondidas
                    respostas.naoRespondidas++;
                else {
                    var acertou = false;

                    // Extrair número de preguntas corretas e erradas
                    for(let alternativa of item.data){
                        if (alternativa.escolhida && alternativa.correta){
                            acertou = true;
                            break;
                        }
                    }

                    if (acertou)
                        respostas.corretas++;
                    else
                        respostas.incorretas++;

                    respostas.respondidas++;
                }
            }

            // Se errou alguma pergunta, mostrar botao para refazer
            $("#btn-refazer").css("display", respostas.incorretas > 0 ? "block": "none");
           
            // Calcular percentual de acerto do questionário  
            console.log(respostas);
            mostrarTelaFinal();

            $("#contagem-corretas").html(`${respostas.corretas}/${respostas.respondidas} Corretas`);
            $("#contagem-erradas").html(`${respostas.incorretas}/${respostas.respondidas} Erradas`);
            $("#contagem-nao-respondidas").html(`${respostas.naoRespondidas}/${respostas.respondidas} Não Respondidas`);
            $("#contagem-percentual").html(`${(respostas.corretas/respostas.respondidas*100).toFixed(0)} % de acerto`);            
        };

        function mostrarTelaFinal(){
            limparTelas();

            // Esconder tela inicio
            $("#responder-questionario").css("display", "none");

            $("#tela-fim").css('display', 'block');
        }

        function alterarPaginacao(){
            $("#paginacao-questionario").html(`${iQuestao+1}/${questionarioRecuperado.data.length}`);
        }

        function mudarBotaoResponder(){
            var etapa = 0;
            var correta = false;

            let iSelecionada = questionarioRecuperado.data[iQuestao].data.findIndex( x=> x.escolhida);

            // Uma alternativa foi selecionada?
            if (iSelecionada == -1)
                $("#btn-responder").addClass("btn-disabled");
            else {
                $("#btn-responder").removeClass("btn-disabled");
                etapa = 1;
            }

            // Foi respondido?
            if (questionarioRecuperado.data[iQuestao].respondida){
                etapa = 2;
                if (questionarioRecuperado.data[iQuestao].data[iSelecionada].correta){
                    $("#btn-responder").addClass("bg-correta");
                    correta = true;
                }
                else {
                    $("#btn-responder").addClass("bg-errada");
                    correta = false;
                }
            }
            else
                $("#btn-responder").removeClass("bg-errada bg-correta");

                switch(etapa){
                    case 0:
                        $("#row-alternativas").css({border: "0px"});
                        $("#btn-responder > div").html("<i class='fa-regular fa-hand-pointer'></i> Selecione uma alternativa"); 
                        break;
                    case 1:
                        $("#row-alternativas").css({border: "0px"});
                        $("#btn-responder > div").html("<i class='fa-solid fa-check'></i> Responder"); 
                        break;
                    case 2:
                        $("#row-alternativas").css({border: `2px solid ${correta ? '#68ff98' : '#ff6868'}`}); 
                        $("#btn-responder > div").html("<i class='fa-solid fa-check-double'></i> Avançar"); 
                        break;
                }
        }

        // Verificar se a questao já foi repsondida
        function jaRespondida(){
            return questionarioRecuperado.data[iQuestao] ? questionarioRecuperado.data[iQuestao].respondida : false
        }

        function irParaHome(){
            window.location.href = "home.html";
        }

        function refazerErradas(){
            var questionarioErradas = {name: questionarioRecuperado.name + " - Correções", data: [], id: questionarioRecuperado.id};

            // Adicionar questoes
            for(let item of questionarioRecuperado.data){
                // Se nao respondeu
                if (!item.respondida){
                    // Adicionar
                    questionarioErradas.data.push(item);
                }
                else {
                    // Se respondeu errado
                    let iCorreta = item.data.findIndex( x=> x.correta);

                    // Se respondeu errado OU nao tem resposta
                    if (iCorreta != -1 && !item.data[iCorreta].escolhida){
                        // Limpa a resposta
                        for(let alternativas of item.data)
                            alternativas.escolhida = false;

                        // Adicionar
                        item.respondida = false;
                        questionarioErradas.data.push(item);
                    }
                }
            }

            questionarioRecuperado = questionarioErradas;

            iniciarQuestionarioRecuperado();
        }
    </script>
</html>