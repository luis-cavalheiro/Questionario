<!DOCTYPE html>
<html>
    <head>
        <!-- Jquery -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

        <!-- bootstrap -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

        <!-- font awesome -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        
        <!-- css -->
        <link rel="stylesheet" href="style.css">

        <!-- Imports -->
        <script type="text/javascript" src="questionario.js"></script>
    </head>
    <body>
        <!-- EDITAR QUESTIONARIO ------------------------------------------------------------------------------------------------------------------------------------------------------>
        <div id="editar-questionario" class="container mt-5">
            <!-- botoes Superiores -->
            <div class="row mt-3">
                <div class="col-sm-12 col-md-1 my-2">
                    <div class="button button-icon" onclick="voltarInicial()">
                        <i class="fa-solid fa-chevron-left"></i>
                    </div>
                </div>
                <div class="col-sm-12 col-md-2 my-2">
                </div>
                <div class="col-sm-12 col-md-2 my-2">
                    <div class="button" onclick="excluirQuestionario()">
                        <div><i class="fa-solid fa-trash-can"></i> Excluir</div>
                    </div>
                </div>
                <div class="col-sm-12 col-md-2 my-2">
                    <div class="button" onclick="baixarQuestionario()">
                        <div><i class="fa-solid fa-download"></i> Baixar</div>
                    </div>
                </div>
                <div class="col-sm-12 col-md-2 my-2">
                    <div class="button" onclick="salvarQuestionario()">
                        <div><i class="fa-solid fa-floppy-disk"></i> Salvar</div>
                    </div>
                </div>
                <div class="col-sm-12 col-md-2 my-2">
                </div>
            </div>
            <!-- Titulo -->
            <div class="row">
                <div class="col-12  mt-5 ">
                    <h3>
                        Titulo Questionário
                    </h3>
                </div>
                <div class="col-12 mb-3">
                    <div>
                        <input type="text" id="titulo-questionario" onchange="mudarTextoTitulo()" value="Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua?">
                    </div>
                </div>
            </div>
            <!-- Alternativas -->
            <div class="col-12  mt-5 ">
                <h3>
                    Perguntas
                </h3>
            </div>
            <div id="lista-perguntas" class="row">
                <div class="col-12">
                    <div class="btn-lista">
                        <div class="button btn-lista-txt">Pergunta 1 <i class="fa-solid fa-pen-to-square edit-icon"></i></div>    
                    </div>
                </div>
            </div>

            <!-- botoes Superiores -->
            <div class="row mt-3">
                <div class="col my-2"></div>
                <div class="col-sm-12 col-md-1 my-2">
                    <div class="button button-icon" onclick="editarPergunta(null)">
                        <i class="fa-solid fa-plus"></i>
                    </div>
                </div>
                <div class="col my-2"></div>
            </div>
        </div>

        <!-- EDITAR Pergunta ---------------------------------------------------------------------------------------------------------------------------------------------------- -->
        <div id="editar-pergunta" class="container mt-5">
            <!-- botoes Superiores -->
            <div class="row mt-3">
                <div class="col-sm-12 col-md-1 my-2">
                    <div class="button button-icon" onclick="abandonarEdicaoPergunta()">
                        <i class="fa-solid fa-chevron-left"></i>
                    </div>
                </div>
                <div class="col-sm-12 col-md-3 my-2">
                </div>
                <div class="col-sm-12 col-md-2 my-2">
                    <div class="button" onclick="excluirPergunta()">
                        <div><i class="fa-solid fa-trash-can"></i> Excluir</div>
                    </div>
                </div>
                <div class="col-sm-12 col-md-2 my-2">
                    <div class="button" onclick="salvarPergunta()">
                        <div><i class="fa-solid fa-floppy-disk"></i> Salvar</div>
                    </div>
                </div>
                <div class="col-sm-12 col-md-3 my-2">
                </div>
            </div>
            <!-- Titulo -->
            <div class="row">
                <div class="col-12 mt-5 mb-3">
                    <div>
                        <input type="text" id="editar-pergunta-titulo" onchange="mudarTextoPergunta()" value="Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua?">
                    </div>
                </div>
            </div>
            <!-- Alternativas -->
            <div id="editar-pergunta-alternativas" class="row">
                <div class="col-12">
                    <div class="btn-lista">
                        <div class="button button-icon button-icon-checkbox ">
                            <i class="fa-solid fa-check" style="display:none"></i>
                        </div>
                        <input type="text" id="alternativa" value="alternativa">
                        <div class="button button-icon button-icon-delete">
                            <i class="fa-solid fa-trash-can"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- botoes Superiores -->
            <div class="row mt-3">
                <div class="col my-2"></div>
                <div class="col-sm-12 col-md-1 my-2">
                    <div class="button button-icon" onclick="adicionarAlternativa()">
                        <i class="fa-solid fa-plus"></i>
                    </div>
                </div>
                <div class="col my-2"></div>
            </div>
        </div>
    </body>

    <script>
        var questionarioRecuperado = null;
        var perguntaEditada = null;
        var iPergunta = -1;

        // ----------------------------- Questionario ---------------------------
        function baixarQuestionario(){
            //console.log(listaQuestionariosRecuperada);
            baixar(questionarioRecuperado);
        }

        function salvarQuestionario(){
            var listaQuestionariosRecuperada = recuperarQuestionariosSessao(NOME_QUESTIONARIOS_LISTA);

            var iQuestionarioAdicionar = listaQuestionariosRecuperada.questionarios.findIndex(x => x.id == questionarioRecuperado.id);

            if(iQuestionarioAdicionar != -1)
                listaQuestionariosRecuperada.questionarios[iQuestionarioAdicionar] = questionarioRecuperado;
            else
                listaQuestionariosRecuperada.questionarios.push(questionarioRecuperado);

            salvarItemSessao(NOME_QUESTIONARIOS_LISTA, listaQuestionariosRecuperada);

            voltarInicial();
        }

        function excluirQuestionario(){
            var listaQuestionariosRecuperada = recuperarQuestionariosSessao(NOME_QUESTIONARIOS_LISTA);

            var iQuestionarioExcluir = listaQuestionariosRecuperada.questionarios.findIndex(x => x.id == questionarioRecuperado.id);
            
            if(iQuestionarioExcluir != -1){
                listaQuestionariosRecuperada.questionarios.splice(iQuestionarioExcluir,1);

                salvarItemSessao(NOME_QUESTIONARIOS_LISTA, listaQuestionariosRecuperada);
            }

            voltarInicial();
        }


        // ----------------------------- Editar Questionario ---------------------------
        function carregarTelaEditarQuestionario(){
            $("#editar-questionario").css("display", "block");
            $("#editar-pergunta").css("display", "none");
        }

        function carregarTelaEditarPergunta(){
            $("#editar-questionario").css("display", "none");
            $("#editar-pergunta").css("display", "block");
        }

        function carregarQuestionarioSessao(){
            // Carrega questionario da sessão
            questionarioRecuperado = recuperarQuestionariosSessao(NOME_QUESTIONARIO)
            var listaQuestionario = recuperarQuestionariosSessao(NOME_QUESTIONARIOS_LISTA)

            if (!questionarioRecuperado){
                questionarioRecuperado = {
                    name: "Novo Questionário",
                    data: [

                    ],
                    id: gerarNovoId(listaQuestionario.questionarios)
                }
            }
            else
                carregarQuestionario();
        }

        // Carregar dados do questionario para editar
        function carregarQuestionario(){
            carregarTelaEditarQuestionario();

            // Preenche campo do titulo do questionario
            $("#titulo-questionario").val(questionarioRecuperado.name);

            // Carrega todas as questoes do questionario
            var htmlPerguntas = "";
            for(let item of questionarioRecuperado.data){
                htmlPerguntas += `
                    <div class="col-12">
                        <div class="btn-lista" onclick="editarPergunta(${item.id})">
                            <div class="button btn-lista-txt">${item.name} <i class="fa-solid fa-pen-to-square edit-icon"></i></div>    
                        </div>
                    </div>
                `;
            }

            $("#lista-perguntas").html(htmlPerguntas);
        }

        carregarQuestionarioSessao();
        carregarQuestionario();

        function mudarTextoTitulo(){
            var novoValor = $("#titulo-questionario").val();
            questionarioRecuperado.name = novoValor;
        }

        // ----------------------------- Editar Pergunta ---------------------------
      
        // Carrega uma pergunta do questionario para ediçao ou abre uma nova pergunta vazia
        function editarPergunta(id){
            carregarTelaEditarPergunta();

            if (id == null){
                perguntaEditada = {
                    name: 'Nova Pergunta',
                    data: [{
                        name: 'Nova Alternativa',
                        correta: true,
                        id: 0
                    }],
                    // Gera um novo id para a pergunta, que nao conflite com as outras perguntas
                    id: gerarNovoId(questionarioRecuperado.data)
                }
            }
            else {
                // Encontrar dados da pergunta
                iPergunta = questionarioRecuperado.data.findIndex(x => x.id == id);

                if (iPergunta != -1){
                    perguntaEditada = questionarioRecuperado.data[iPergunta];
                }
            }

            mostrarPergunta();
        }

        // Mostra pergunta a ser editada na tela
        function mostrarPergunta(){
            console.log(perguntaEditada);

            // Preenche campo de texto da pergunta
            $("#editar-pergunta-titulo").val(perguntaEditada.name);

            // Carrega alternativas
            let htmlAlternativas = "";
            for(let item of perguntaEditada.data){
                // Se a alternativa for a correta, sinaliza 
                htmlAlternativas += `
                    <div class="col-12">
                        <div class="btn-lista">
                            <div class="button button-icon button-icon-checkbox ${item.correta ? "button-icon-checkbox-checked" : ""}" onclick="selecionarAlternativaCorreta(${item.id})">
                                <i class="fa-solid fa-check" style="display:none"></i>
                            </div>
                            <input type="text" id="alternativa-${item.id}" class="alternativa" value="${item.name}" onchange="mudarTextoAlternativa(${item.id})">
                            <div class="button button-icon button-icon-delete" onclick="removerAlternativa(${item.id})">
                                <i class="fa-solid fa-trash-can"></i>
                            </div>
                        </div>
                    </div>
                `;
            }
            $("#editar-pergunta-alternativas").html(htmlAlternativas);
        }

        // Adiciona uma alternativa a uma pergunta
        function adicionarAlternativa(){
            // gerarNovoId(perguntaEditada.data)
            perguntaEditada.data.push({
                    name: 'Nova Alternativa',
                    correta: false,
                    id: gerarNovoId(perguntaEditada.data)
                });

                mostrarPergunta();
        }

        // Remove uma alternativa de uma pergunta
        function removerAlternativa(id){
            //console.log("Removendo alternativa " + id);
            var iAlternativa = perguntaEditada.data.findIndex(x => x.id == id);

            if (iAlternativa != -1){
                perguntaEditada.data.splice(iAlternativa, 1);
                mostrarPergunta();
            }
        }

        // Define qual a resposta correta de uma pergunta
        function selecionarAlternativaCorreta(id){
            console.log("Selecionando alternativa " + id);

            for(let item of perguntaEditada.data){
                item.correta = item.id == id;
            }

            mostrarPergunta();
        }

        // Salva alteraçoes da pergunta no questionario
        function salvarPergunta(){
        let iPerguntaEncontrada = questionarioRecuperado.data.findIndex(x => x.id == perguntaEditada.id);            
        
        // Se a pergunta já existe
        if (iPerguntaEncontrada != -1){
            // Replace it
            questionarioRecuperado.data[iPergunta] = perguntaEditada;
        }
        else {
            // Adiciona a nova pergunta
            questionarioRecuperado.data.push(perguntaEditada);
        }

        carregarQuestionario();
    }

        function mudarTextoPergunta(){
            var novoValor = $("#editar-pergunta-titulo").val();
            perguntaEditada.name = novoValor;
        }

        function mudarTextoAlternativa(id){
           var novoValor = $("#alternativa-"+id).val();

           var iAlternativa = perguntaEditada.data.findIndex( x => x.id == id);

           if (iAlternativa != -1){
            perguntaEditada.data[iAlternativa].name = novoValor;
           }
        }
    
        // Exclui uma pergunta do questionario
        function excluirPergunta(){
        let iPerguntaDeletar = questionarioRecuperado.data.findIndex( x => x.id == perguntaEditada.id);

        if (iPerguntaDeletar != -1){
            questionarioRecuperado.data.splice(iPerguntaDeletar, 1);

            carregarQuestionario();
        }
    }

        // ----------------------------- Navegar ---------------------------
        function voltarInicial(){
            // volta para a tela inicial
            window.location.href = "home.html";
        }

        function abandonarEdicaoPergunta(){
            carregarQuestionario();
        }
    </script>
</html>