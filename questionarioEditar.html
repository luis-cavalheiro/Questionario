<!DOCTYPE html>
<html>
    <head>
        <!-- Jquery -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

        <!-- bootstrap -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

        <!-- font awesome -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        
        <!-- css -->
        <link rel="stylesheet" href="style.css">

        <!-- Imports -->
        <script type="text/javascript" src="questionario.js"></script>
        <script type="text/javascript" src="db.js"></script>    
    </head>
    <body>
        <!-- EDITAR QUESTIONARIO ------------------------------------------------------------------------------------------------------------------------------------------------------>
        <div id="editar-questionario" class="container mt-5">
            <!-- botoes Superiores -->
            <div class="row mt-3">
                <!-- Voltar -->
                <div class="col-md-12 col-lg-1 my-2">
                    <div class="button button-icon" onclick="voltarInicial()">
                        <i class="fa-solid fa-chevron-left"></i>
                    </div>
                </div>
                <div class="col-md-12 col-lg-2 my-2">
                </div>
                <!-- Excluir -->
                <div class="col-md-12 col-lg-2 my-2">
                    <div class="button" onclick="excluirQuestionario()">
                        <div><i class="fa-solid fa-trash-can"></i> Excluir</div>
                    </div>
                </div>
                <!-- Baixar -->
                <div class="col-md-12 col-lg-2 my-2">
                    <div class="button" onclick="baixarQuestionario()">
                        <div><i class="fa-solid fa-download"></i> Baixar</div>
                    </div>
                </div>
                <!-- Salvar -->
                <div class="col-md-12 col-lg-2 my-2">
                    <div class="button" onclick="salvarQuestionario()">
                        <div><i class="fa-solid fa-floppy-disk"></i> Salvar</div>
                    </div>
                </div>
                <div class="col-md-12 col-lg-2 my-2">
                </div>
            </div>
            <!-- Titulo Questionário -->
            <div class="row">
                <div class="col-12  mt-5 ">
                    <h3>
                        Titulo Questionário
                    </h3>
                </div>
                <div class="col-12 mb-3">
                    <div>
                        <input type="text" id="titulo-questionario" onchange="mudarTextoTitulo()" value="Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua?">
                    </div>
                </div>
            </div>

            <!-- Listagem Perguntas -->
            <div class="col-12  mt-5 ">
                <h3>
                    Perguntas
                </h3>
            </div>
              <!-- Botao Adicionar Pergunta -->
              <div class="row mt-3">
                <div class="col my-2"></div>
                <div class="col-md-12 col-lg-1 my-2">
                    <div class="button button-icon" onclick="editarPergunta(null)">
                        <i class="fa-solid fa-plus"></i>
                    </div>
                </div>
                <div class="col my-2"></div>
            </div>  
            <div id="lista-perguntas" class="row">
                <div class="col-12">
                    <div class="btn-lista">
                        <div class="button btn-lista-txt">Pergunta 1 <i class="fa-solid fa-pen-to-square edit-icon"></i></div>    
                    </div>
                </div>
            </div>

          
        </div>

        <!-- EDITAR Pergunta ---------------------------------------------------------------------------------------------------------------------------------------------------- -->
        <div id="editar-pergunta" class="container mt-5">
            <!-- botoes Superiores -->
            <div class="row mt-3">
                <div class="col-md-12 col-lg-1 my-2">
                    <div class="button button-icon" onclick="abandonarEdicaoPergunta()">
                        <i class="fa-solid fa-chevron-left"></i>
                    </div>
                </div>
                <div class="col-md-12 col-lg-3 my-2">
                </div>
                <div class="col-md-12 col-lg-2 my-2">
                    <div class="button" onclick="excluirPergunta()">
                        <div><i class="fa-solid fa-trash-can"></i> Excluir</div>
                    </div>
                </div>
                <div class="col-md-12 col-lg-2 my-2">
                    <div class="button" onclick="salvarPergunta()">
                        <div><i class="fa-solid fa-floppy-disk"></i> Salvar</div>
                    </div>
                </div>
                <div class="col-md-12 col-lg-3 my-2">
                </div>
            </div>
            <!-- Titulo -->
            <div class="row">
                <div class="col-12 mt-5 mb-3">
                    <h3>
                        Título Pergunta
                    </h3>
                </div>
                <div class="col-12">
                    <div class="row">
                        <div class="col-md-12 col-lg-2">
                            <!-- img-->
                            <div class="img-upload">
                                <label for="input-img-pergunta" class="button">
                                    <div><i class="fa-solid fa-upload"></i> Imagem</div>
                                </label>
                                <input type="file" id="input-img-pergunta" onchange="handleImageUpload('id', 'input-img-pergunta')" class="button" accept=".png,.jpeg, .jpg" style="display:none;">
                            </div>
                        </div>
                        <!-- texto -->
                        <div class="col-md-12 col-lg-10">
                            <textarea type="text" id="editar-pergunta-titulo" class="w-100" style="min-height: 100%;" value=""  onchange="mudarTextoPergunta()">
                                Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua?
                            </textarea>
                            <!--<input type="textarea" id="editar-pergunta-titulo" onchange="mudarTextoPergunta()" value="Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua?">-->
                        </div>
                    </div>
                    
                    <div class="w-100 my-3">
                        <img id="img-pergunta"  onclick="removeIMG('id', 'input-img-pergunta')"/>
                    </div>
                </div>
            </div>
            <!-- Card escondido -->
            <div id="area-resposta-escondida" class="row mt-5 mb-3 border-top">
                <div class="col-12">
                    <h3>
                        Card <i id="i-card" class="fa-solid fa-eye" onclick="mostrarCard()"></i>
                    </h3>
                </div>
                <div id="col-card" class="col-12 mb-3" style="display:none;">
                    <div id="card-revelar-resposta" class="sombra " style="display: flex;max-width: unset;">
                        <div class="w-100">
                            <textarea type="text" id="card" class="w-100 background-dica" style="min-height: 100%;" value=""  onchange="mudarCardPergunta()">
                            </textarea>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Alternativas -->
            <div class="row border-top">
                <div class="col-12">
                    <h3 class="">
                        Alternativas
                    </h3>
                </div>
            </div>
            <div id="editar-pergunta-alternativas" class="row">
                <div class="col-12">
                    <div class="btn-lista">
                        <div class="button button-icon button-icon-checkbox ">
                            <i class="fa-solid fa-check" style="display:none"></i>
                        </div>
                        <input type="text" id="alternativa" value="alternativa">
                        <div class="button button-icon button-icon-delete">
                            <i class="fa-solid fa-trash-can"></i>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Explicacao -->
            <div id="area-explicacao" class="row mt-5 mb-3 border-top">
                <div class="col-12">
                    <h3>
                        Explicação <i id="i-explicacao" class="fa-solid fa-eye" onclick="mostrarExplicacao()"></i>
                    </h3>
                </div>
                <div id="col-explicacao" class="row"  style="display:none;">
                    <div class="col-md-12 col-lg-2">
                        <!-- img-->
                        <div class="img-upload">
                            <label for="input-img-explicacao" class="button">
                                <div><i class="fa-solid fa-upload"></i> Imagem</div>
                            </label>
                            <input type="file" id="input-img-explicacao" onchange="handleImageUpload('id','input-img-explicacao')" class="button" accept=".png,.jpeg, .jpg" style="display:none;">
                        </div>
                    </div>
                    <div class="col-md-12 col-lg-10 mb-3" >
                        <div class="sombra" style="display: flex;max-width: unset;">
                            <div class="w-100">
                                <textarea type="text" id="explicacao" class="w-100 h-100 background-dica" value=""  onchange="mudarExplicacaoPergunta()">
                                </textarea>
                            </div>
                        </div>
                    </div>
                    <div class="w-100 my-3">
                        <img id="img-explicacao" onclick="removeIMG('id', 'input-img-explicacao')"/>
                    </div>
                </div>
            </div>
            <!-- botoes Superiores -->
            <div class="row mt-3">
                <div class="col my-2"></div>
                <div class="col-sm-12 col-md-6 my-2">
                    <div class="button button-icon" onclick="adicionarAlternativa()">
                        <i class="fa-solid fa-plus"></i>
                    </div>
                </div>
                <div class="col my-2"></div>
            </div>
        </div>
    </body>

    <script>
        var questionarioRecuperado = null;
        var perguntaEditada = null;
        var iPergunta = -1;

        // ----------------------------- Questionario ---------------------------
        function baixarQuestionario(){
            //console.log(listaQuestionariosRecuperada);
            baixarQuestionarioDB(questionarioRecuperado);
        }

        async function salvarQuestionario(){
            if (questionarioRecuperado){
                await atualizarQuestionarioDB(questionarioRecuperado);
            }

            voltarInicial();
        }

        async function excluirQuestionario(){
            if (questionarioRecuperado){
                await deletarQuestionarioDB(questionarioRecuperado);
            }

            // var listaQuestionariosRecuperada = recuperarQuestionariosSessao(NOME_QUESTIONARIOS_LISTA);

            // var iQuestionarioExcluir = listaQuestionariosRecuperada.questionarios.findIndex(x => x.id == questionarioRecuperado.id);
            
            // if(iQuestionarioExcluir != -1){
            //     listaQuestionariosRecuperada.questionarios.splice(iQuestionarioExcluir,1);

            //     salvarItemSessao(NOME_QUESTIONARIOS_LISTA, listaQuestionariosRecuperada);
            // }

            voltarInicial();
        }

        // ----------------------------- Editar Questionario ---------------------------
        
        function carregarTelaEditarPergunta(){
            $("#editar-questionario").css("display", "none");
            $("#editar-pergunta").css("display", "block");
        }

        async function carregarQuestionarioSessao(){
            // Carrega questionario da sessão
            questionarioRecuperado = await getQuestionario(recuperarQuestionariosSessao(NOME_QUESTIONARIO));

            //var listaQuestionario = recuperarQuestionariosSessao(NOME_QUESTIONARIOS_LISTA)

            if (!questionarioRecuperado){
                questionarioRecuperado = {
                    name: "Novo Questionário",
                    data: [

                    ],
                    //id: gerarNovoId(listaQuestionario.questionarios)
                }
            }
             
            carregarQuestionario();
        }

        carregarQuestionarioSessao();

        function carregarTelaEditarQuestionario(){
            $("#editar-questionario").css("display", "block");
            $("#editar-pergunta").css("display", "none");
        }

        // Carregar dados do questionario para editar
        function carregarQuestionario(){
            carregarTelaEditarQuestionario();

            if (questionarioRecuperado){
                // Preenche campo do titulo do questionario
                $("#titulo-questionario").val(questionarioRecuperado.name);

                // Carrega todas as questoes do questionario
                var htmlPerguntas = "";

                if (questionarioRecuperado.data != null)
                    for(let i = questionarioRecuperado.data.length - 1; i >= 0; i--){
                        let item = questionarioRecuperado.data[i];

                        htmlPerguntas += `
                            <div class="col-md-12 col-lg-10 mb-4">
                                <div id="pergunta-${item.id}" class="btn-lista" onclick="editarPergunta(${item.id})">
                                    <div class="button btn-lista-txt">
                                        <div>
                                        [${item.id}] ${item.name} <i class="fa-solid fa-pen-to-square edit-icon"></i>
                                        </div>
                                    </div>    
                                </div>
                            </div>
                            <div class="col-md-12 col-lg-1 mb-4">
                                <div class="button button-icon" onclick="copiarPergunta(${item.id})">
                                    <i class="fa-solid fa-copy"></i>
                                </div>
                            </div>
                             <div class="col-md-12 col-lg-1 mb-4">
                                <div class="button button-icon button-icon-delete" onclick="excluirPergunta(${item.id})">
                                    <i class="fa-solid fa-trash-can"></i>
                                </div>
                            </div>
                        `;
                    }

                // for(let item of questionarioRecuperado.data){
                //     htmlPerguntas += `
                //         <div class="col-md-12 col-lg-11 mb-4">
                //             <div class="btn-lista" onclick="editarPergunta(${item.id})">
                //                 <div class="button btn-lista-txt">
                //                     <div>
                //                         ${item.name} <i class="fa-solid fa-pen-to-square edit-icon"></i>
                //                     </div>
                //                 </div>    
                //             </div>
                //         </div>
                //         <div class="col-md-12 col-lg-1 mb-4">
                //             <div class="button button-icon" onclick="copiarPergunta(${item.id})">
                //                 <i class="fa-solid fa-copy"></i>
                //             </div>
                //         </div>
                //     `;
                // }

                $("#lista-perguntas").html(htmlPerguntas);
            }
        }

        function mudarTextoTitulo(){
            var novoValor = $("#titulo-questionario").val();
            questionarioRecuperado.name = novoValor;
        }

        // ----------------------------- Editar Pergunta ---------------------------
      
        // Carrega uma pergunta do questionario para ediçao ou abre uma nova pergunta vazia
        function copiarPergunta(id){
            // Encontrar dados da pergunta
            iPergunta = questionarioRecuperado.data.findIndex(x => x.id == id);

            if (iPergunta != -1){
                carregarTelaEditarPergunta();

                var perguntaCopiada = questionarioRecuperado.data[iPergunta];

                perguntaEditada = {
                    name: perguntaCopiada.name,
                    escondida: perguntaCopiada.escondida,
                    dica: perguntaCopiada.dica,
                    data: [],
                    // Gera um novo id para a pergunta, que nao conflite com as outras perguntas
                    id: gerarNovoId(questionarioRecuperado.data),
                    img: perguntaCopiada.img,
                    imgExplicacao: perguntaCopiada.imgExplicacao
                }

                for (let item of perguntaCopiada.data){
                    perguntaEditada.data.push({
                        name: item.name,
                        id: gerarNovoId(perguntaEditada.data),
                        correta: item.correta,
                        dica: item.dica,
                        img: item.img,
                        imgExplicacao: item.imgExplicacao
                    });
                }

                console.log("copiou pergunta");
                mostrarPergunta();
            }
        }

        function editarPergunta(id){
            carregarTelaEditarPergunta();

            if (id == null){
                perguntaEditada = {
                    name: 'Nova Pergunta',
                    data: [{
                        name: 'Certo',
                        correta: true,
                        id: 0
                    },
                    {
                        name: 'Errado',
                        correta: false,
                        id: 1
                    }],
                    // Gera um novo id para a pergunta, que nao conflite com as outras perguntas
                    id: gerarNovoId(questionarioRecuperado.data)
                }
            }
            else {
                // Encontrar dados da pergunta
                iPergunta = questionarioRecuperado.data.findIndex(x => x.id == id);

                if (iPergunta != -1){
                    perguntaEditada = questionarioRecuperado.data[iPergunta];
                }
            }

            mostrarPergunta();
        }

        const fileInput = document.getElementById('fileInput');
        const reader = new FileReader();

        // Mostra pergunta a ser editada na tela
        function mostrarPergunta(){
            console.log(perguntaEditada);

            // Preenche campo de texto da pergunta
            $("#editar-pergunta-titulo").val(perguntaEditada.name);

            console.log(perguntaEditada.img);
            $("#img-pergunta").attr('src', perguntaEditada.img ? perguntaEditada.img : '');

            // Carregar card dica
            $("#card").val(perguntaEditada.escondida ? perguntaEditada.escondida : "");

            mostrarCard(typeof perguntaEditada.escondida == "undefined" ? false : true);

            // Explicação
            $("#explicacao").val(perguntaEditada.dica ? perguntaEditada.dica : "");

            mostrarExplicacao(typeof perguntaEditada.dica != "undefined" || typeof perguntaEditada.imgExplicacao != "undefined");

            $("#img-explicacao").attr('src', perguntaEditada.imgExplicacao ? perguntaEditada.imgExplicacao : '');

            // Carrega alternativas
            let htmlAlternativas = "";
            for(let item of perguntaEditada.data){
                var img = "";
                var imgAlternativaExplicacao = '';

                if (item.img)
                    img = `<div class="w-100 mb-5">
                            <img id="img-${item.id}" src="${item.img}" onclick="removeIMG('alternativa', ${item.id});"/>
                        </div>`;

                if (item.imgExplicacao)
                        imgAlternativaExplicacao = `<div class="w-100 mb-5">
                            <img id="img-explicacao-${item.id}" src="${item.imgExplicacao}" onclick="removeIMG('explicacao', ${item.id});"/>
                        </div>`;

                

                // Se a alternativa for a correta, sinaliza 
                htmlAlternativas += `
                    <div class="col-12 mb-4">
                        <div class="btn-lista row w-100">
                                <div class="col-md-12 col-lg-1 my-3">
                                    <div class="button w-100 button-icon button-icon-checkbox ${item.correta ? "button-icon-checkbox-checked" : ""}" onclick="selecionarAlternativaCorreta(${item.id})">
                                        <i class="fa-solid fa-check" style="color: #d5d4d4"></i>
                                    </div>  
                                </div>
                                <div class="col-md-12 col-lg-2 my-3">
                                    <div class="img-upload">
                                        <label for="image-input-${item.id}" class="button">
                                            <div><i class="fa-solid fa-upload"></i> Imagem</div>
                                        </label>
                                        <input type="file" id="image-input-${item.id}" onchange="handleImageUpload('alternativa', '${item.id}')" class="button"  accept=".png,.jpeg, .jpg" style="display:none;">
                                    </div>
                                </div>
                                <div class="col-md-12 col-lg-8 my-3">
                                    <textarea type="text" id="alternativa-${item.id}" class="alternativa w-100 h-100"  onchange="mudarTextoAlternativa(${item.id})">${item.name}</textarea>
                                </div>
                                <div class="col-md-12 col-lg-1 my-3">
                                    <div class="button button-icon button-icon-delete" onclick="removerAlternativa(${item.id})">
                                        <i class="fa-solid fa-trash-can"></i>
                                    </div>
                                </div>
                                ${img}
                                <div class="col-md-12 col-lg-2 my-3">
                                    <div class="img-upload">
                                        <label for="image-input-explicacao-${item.id}" class="button">
                                            <div><i class="fa-solid fa-upload"></i> Imagem</div>
                                        </label>
                                        <input type="file" id="image-input-explicacao-${item.id}" onchange="handleImageUpload('explicacao', '${item.id}')" class="button"  accept=".png,.jpeg, .jpg" style="display:none;">
                                    </div>
                                </div>
                                <div class="col-md-12 col-lg-10 my-1">
                                    <textarea type="text" id="explicacao-${item.id}" class="w-100 h-100 background-dica" value="" onchange="mudarTextoAlternativa(${item.id})">${item.dica ? item.dica : ""}</textarea>
                                </div>
                        </div>   
                        
                        ${imgAlternativaExplicacao}
                    </div>
                `;
            }

            $("#editar-pergunta-alternativas").html(htmlAlternativas);


        }

        function removeIMG(categoria, id){
            switch(categoria){
                case 'explicacao':
                    let iExplicacaoAlternativa = perguntaEditada.data.findIndex(x => x.id == id);

                    if (iExplicacaoAlternativa != -1)
                        // Save the base64 string in the object
                        perguntaEditada.data[iExplicacaoAlternativa].imgExplicacao =  undefined;
                    break;
                case 'alternativa':
                    let iAlternativa = perguntaEditada.data.findIndex(x => x.id == id);

                    if (iAlternativa != -1)
                        // Save the base64 string in the object
                        perguntaEditada.data[iAlternativa].img =  undefined;
                    break;
                case 'id':
                    switch(id){
                        case 'input-img-pergunta':
                            perguntaEditada.img = undefined;
                            break;
                        case 'input-img-explicacao':
                            perguntaEditada.imgExplicacao = undefined;
                            break;
                    }
                    break;
            }

            mostrarPergunta();
        }

        // Function to handle image file input and convert it to base64
        function handleImageUpload(categoria, id) {
            console.log('salvando em ' + categoria);
            var file;

            switch(categoria){
                case 'explicacao':
                    file = $(`#image-input-explicacao-${id}`)[0].files[0];
                    break;
                case 'alternativa':
                    file = $(`#image-input-${id}`)[0].files[0];
                    break;
                case 'id':
                    file = $(`#${id}`)[0].files[0];
                    break;
            }

            // if (!isNaN(Number(id)))
            //     file = $(`#image-input-${id}`)[0].files[0];
            // else
            //     file = $(`#${id}`)[0].files[0];

            // Check if a file was selected
            if (file) {
                const reader = new FileReader();
                
                // Read the file as a Data URL (base64 encoded string)
                reader.readAsDataURL(file);
                
                reader.onload = function() {
                    switch(categoria){
                        case 'explicacao':
                            let iExplicacaoAlternativa = perguntaEditada.data.findIndex(x => x.id == id);

                            if (iExplicacaoAlternativa != -1)
                                // Save the base64 string in the object
                                perguntaEditada.data[iExplicacaoAlternativa].imgExplicacao =  reader.result;
                            break;
                        case 'alternativa':
                            let iAlternativa = perguntaEditada.data.findIndex(x => x.id == id);

                            if (iAlternativa != -1)
                                // Save the base64 string in the object
                                perguntaEditada.data[iAlternativa].img =  reader.result;
                            break;
                        case 'id':
                            switch(id){
                                case 'input-img-pergunta':
                                    perguntaEditada.img = reader.result;
                                    break;
                                case 'input-img-explicacao':
                                    perguntaEditada.imgExplicacao = reader.result;
                                    break;
                            }
                            break;
                    }

                    // if (!isNaN(Number(id))){
                    //     let iAlternativa = perguntaEditada.data.findIndex(x => x.id == id);

                    //     if (iAlternativa != -1)
                    //         // Save the base64 string in the object
                    //         perguntaEditada.data[iAlternativa].img =  reader.result;
                    // }
                    // else {
                    //     switch(id){
                    //         case 'input-img-pergunta':
                    //             perguntaEditada.img = reader.result;
                    //             break;
                    //         case 'input-img-explicacao':
                    //             perguntaEditada.imgExplicacao = reader.result;
                    //             break;
                    //     }

                        
                    // }

                    mostrarPergunta();
                };
                
                reader.onerror = function(error) {
                    console.log('Error reading file:', error);
                };
            }
        }

  

        // Adiciona uma alternativa a uma pergunta
        function adicionarAlternativa(){
            // gerarNovoId(perguntaEditada.data)
            perguntaEditada.data.push({
                    name: '',
                    correta: false,
                    id: gerarNovoId(perguntaEditada.data)
                });

                mostrarPergunta();
        }

        // Remove uma alternativa de uma pergunta
        function removerAlternativa(id){
            //console.log("Removendo alternativa " + id);
            var iAlternativa = perguntaEditada.data.findIndex(x => x.id == id);

            if (iAlternativa != -1){
                perguntaEditada.data.splice(iAlternativa, 1);
                mostrarPergunta();
            }
        }

        // Define qual a resposta correta de uma pergunta
        function selecionarAlternativaCorreta(id){
            console.log("Selecionando alternativa " + id);

            for(let item of perguntaEditada.data){
                if (item.id == id)
                    item.correta = !item.correta;
            }

            mostrarPergunta();
        }

        // Salva alteraçoes da pergunta no questionario
        function salvarPergunta(){
        let iPerguntaEncontrada = questionarioRecuperado.data.findIndex(x => x.id == perguntaEditada.id);            

        // É multipla escolha?
        var corretas = 0;
        for(let alternativa of perguntaEditada.data)
            corretas += corretas + alternativa.correta ? 1 : 0;

        perguntaEditada.multiplaEscolha = (corretas > 0);
        
        // Se a pergunta já existe
        if (iPerguntaEncontrada != -1){
            // Replace it
            questionarioRecuperado.data[iPergunta] = perguntaEditada;
        }
        else {
            // Adiciona a nova pergunta
            questionarioRecuperado.data.push(perguntaEditada);
        }

        carregarQuestionario();

        sinalizarPerguntaEditada();
    }

        function mudarTextoPergunta(){
            var novoValorTexto = $("#editar-pergunta-titulo").val();

            perguntaEditada.name = novoValorTexto;
        }

        function mudarTextoAlternativa(id){
           var novoValorTexto = $("#alternativa-"+id).val();
           var novoValorExplicacao = $("#explicacao-"+id).val();

           var iAlternativa = perguntaEditada.data.findIndex( x => x.id == id);

           if (iAlternativa != -1){
                perguntaEditada.data[iAlternativa].name = novoValorTexto;
                perguntaEditada.data[iAlternativa].dica = novoValorExplicacao != "" ? novoValorExplicacao : null;
           }
        }
    
        function mudarCardPergunta(){
            var novoValor = $("#card").val();
            perguntaEditada.escondida = novoValor;
        }

        function mudarExplicacaoPergunta(){
            var novoValor = $("#explicacao").val();
            perguntaEditada.dica = novoValor;
        }

        // Exclui uma pergunta do questionario
        function excluirPergunta(id){
            id = id ? id : perguntaEditada.id;

            let iPerguntaDeletar = questionarioRecuperado.data.findIndex( x => x.id == id);

            if (iPerguntaDeletar != -1){
                questionarioRecuperado.data.splice(iPerguntaDeletar, 1);

                carregarQuestionario();
            }
        }

        // ----------------------------- Navegar ---------------------------
        function voltarInicial(){
            // volta para a tela inicial
            window.location.href = "index.html";
        }

        function abandonarEdicaoPergunta(){
            carregarQuestionario();

            sinalizarPerguntaEditada();
        }
    
        function mostrarCard(mostrar){
            if (typeof mostrar != "boolean")
                mostrar = $("#i-card").hasClass("fa-eye");

            $("#i-card").removeClass("fa-eye fa-eye-slash");

            $("#i-card").addClass(mostrar ? "fa-eye-slash" :  "fa-eye");

            $("#col-card").css("display", mostrar? "block" : "none");
        }

        function mostrarExplicacao(mostrar){
            if (typeof mostrar != "boolean")
                mostrar = $("#i-explicacao").hasClass("fa-eye");

            $("#i-explicacao").removeClass("fa-eye fa-eye-slash");

            $("#i-explicacao").addClass(mostrar ? "fa-eye-slash" :  "fa-eye");

            $("#col-explicacao").css("display", mostrar? "" : "none");
        }
    
        function sinalizarPerguntaEditada(){
            if (perguntaEditada && perguntaEditada.id){
                // Ir para a pergunta
                location.href = "#pergunta-"+perguntaEditada.id;   
                $("#pergunta-"+perguntaEditada.id + " > div").addClass("button-selected");
            }
        }
    </script>
</html>
